stages:
  - quality
  - unit-test
  - integration-test
  - build
  - analysis
  - security
  - deploy
  - post-deploy-check
  - rollback

# Stages

unit-tests:
  stage: unit-test
  script: ./gradlew test
  artifacts:
    paths:
      - build/reports/tests/
    reports:
      junit: build/test-results/test/*.xml

integration-tests:
  stage: integration-test
  script: ./gradlew integrationTest
  artifacts:
    paths:
      - build/reports/integration-tests/
    reports:
      junit: build/test-results/integrationTest/*.xml

mutation-tests:
  stage: quality
  script: ./gradlew pitest
  artifacts:
    paths:
      - build/reports/pitest/

sonar-analysis:
  stage: analysis
  image: gradle:8.7-jdk23
  variables:
    SONAR_HOST_URL: "https://sonarcloud.io"
    SONAR_PROJECT_KEY: "USUARIO_TEMPLATE-SERVICE"
    SONAR_ORGANIZATION: "USUARIO"
  script:
    - ./gradlew sonarqube
      -Dsonar.projectKey=$SONAR_PROJECT_KEY
      -Dsonar.organization=$SONAR_ORGANIZATION
      -Dsonar.host.url=$SONAR_HOST_URL
      -Dsonar.token=0779d80a2182a86d3a319d2fcbb8450aec191d87
  only:
    - main
  artifacts:
    paths:
      - build/reports/sonarqube/


# ðŸ”¹ Nuevo Job: ActualizaciÃ³n de Dependencias
check-for-updates:
  stage: security
  script:
    - ./gradlew dependencyUpdates
  only:
    - develop
  artifacts:
    paths:
      - build/reports/dependency-updates-report.txt

# ðŸ”¹ Seguridad: Escaneo de Dependencias
dependency-scan:
  stage: security
  script:
    - ./gradlew dependencyCheckAnalyze
  artifacts:
    paths:
      - build/reports/dependency-check-report.html
  allow_failure: false # Falla el build si hay vulnerabilidades crÃ­ticas

# ðŸ”¹ Seguridad: Escaneo de Contenedores
docker-scan:
  stage: security
  script:
    - trivy image my-app:${CI_COMMIT_SHA}
  only:
    - main

deploy:
  stage: deploy
  script: helm upgrade my-app .
  only:
    - main

health-check:
  stage: post-deploy-check
  script: |
    until curl --fail "$HEALTH_CHECK_URL"; do
      echo "Waiting for service to be healthy...";
      sleep 5;
    done

rollback:
  stage: rollback
  script:
    - helm rollback my-app
    - echo "Esperando que el servicio vuelva a estar saludable..."
    - until curl --fail "$HEALTH_CHECK_URL"; do
      echo "Esperando servicio...";
      sleep 5;
      done
    - echo "Rollback completado con Ã©xito!"
  only:
    - rollback

deploy-argocd:
  stage: deploy
  script:
    - kubectl apply -f argocd/app.yaml
    - argocd app sync template-service
  only:
    - main

